<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Relatório Consolidado</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #525659; padding: 40px 0; }
        .page { background: white; width: 210mm; min-height: 297mm; margin: 0 auto 30px auto; padding: 20mm; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .page-break { page-break-before: always; }
        
        .chart-img {
            max-width: 100%;
            height: auto;
            max-height: 450px; /* Limita altura para caber na folha */
            display: block;
            margin: 20px auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .analysis-header { border-bottom: 3px solid #0f172a; margin-bottom: 20px; padding-bottom: 10px; }
        .analysis-title { font-size: 24px; font-weight: 800; color: #1e293b; }
        
        .concept-box { background: #f1f5f9; border-left: 5px solid #2563eb; padding: 15px; margin-bottom: 20px; font-size: 0.9rem; color: #475569; }

        @media print {
            body { background: white; padding: 0; }
            .page { box-shadow: none; margin: 0; width: 100%; page-break-after: always; }
            .d-print-none { display: none !important; }
        }
    </style>
</head>
<body>

    <div class="d-print-none text-center mb-4">
        <button onclick="window.print()" class="btn btn-primary fw-bold btn-lg shadow"><i class="fas fa-print me-2"></i> Imprimir / PDF</button>
        <a href="/" class="btn btn-outline-light ms-2">Voltar ao Dashboard</a>
    </div>

    <div class="page">
        <div style="height: 100%; display: flex; flex-direction: column; justify-content: center; text-align: center; border: 2px solid #1e293b; padding: 40px;">
            <i class="fas fa-chart-pie text-primary" style="font-size: 80px; margin-bottom: 30px;"></i>
            <h1 style="font-weight: 900; font-size: 40px; text-transform: uppercase;">Relatório Técnico</h1>
            <h3 class="text-muted">Gestão da Qualidade & Melhoria Contínua</h3>
            
            <div style="margin: 60px 0; text-align: left; width: 80%; margin-left: auto; margin-right: auto;">
                <h5 class="border-bottom pb-2 mb-3 fw-bold">Conteúdo do Relatório:</h5>
                <ul class="list-group list-group-flush">
                    {% for item in itens %}
                    <li class="list-group-item d-flex justify-content-between">
                        <span>{{ loop.index }}. {{ item.titulo }}</span>
                        <span class="badge bg-secondary">{{ item.tipo|upper }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>

            <div style="margin-top: auto; border-top: 1px solid #ccc; padding-top: 20px; font-size: 14px;">
                Gerado em: <strong>{{ hoje.strftime('%d/%m/%Y às %H:%M') }}</strong>
            </div>
        </div>
    </div>

    {% for item in itens %}
    <div class="page page-break">
        
        <div class="analysis-header">
            <div class="d-flex justify-content-between align-items-end">
                <div>
                    <div class="text-uppercase small text-muted fw-bold">{{ item.tipo }}</div>
                    <div class="analysis-title">{{ item.titulo }}</div>
                </div>
                <div class="text-end text-muted small">
                    ID #{{ item.id }}<br>{{ item.data_criacao }}
                </div>
            </div>
        </div>

        {% if item.tipo == 'pareto' %}
            <div class="concept-box"><strong>Conceito:</strong> O Princípio de Pareto afirma que 80% dos efeitos vêm de 20% das causas. Use este gráfico para priorizar onde atuar.</div>
        {% elif item.tipo == 'histograma' %}
            <div class="concept-box"><strong>Conceito:</strong> O Histograma mostra a frequência dos dados. É útil para ver se o processo segue uma distribuição normal (sino) e sua variação.</div>
        {% elif item.tipo == 'cep' %}
            <div class="concept-box"><strong>Conceito:</strong> O Gráfico de Controle monitora a estabilidade. Pontos fora dos limites vermelhos indicam causas especiais que exigem ação imediata.</div>
        {% elif item.tipo == 'dispersao' %}
            <div class="concept-box"><strong>Conceito:</strong> Mostra a correlação entre duas variáveis. Se os pontos formam uma linha, uma variável influencia a outra diretamente.</div>
        {% endif %}

        {% if item.dados.grafico %}
            <div class="text-center">
                <img src="{{ item.dados.grafico }}" class="chart-img" alt="Gráfico da Análise">
            </div>
        {% endif %}

        {% if item.tipo == 'pareto' %}
            <h5 class="fw-bold mt-4"><i class="fas fa-table"></i> Dados Detalhados</h5>
            <table class="table table-striped table-sm text-center">
                <thead class="table-dark"><tr><th class="text-start">Item</th><th>Valor</th><th>% Acum.</th></tr></thead>
                <tbody>
                    {% for row in item.dados.itens %}
                    <tr class="{{ 'fw-bold bg-warning bg-opacity-25' if row.perc.replace('%','')|float <= 80 else '' }}">
                        <td class="text-start">{{ row.label }}</td>
                        <td>{{ row.value }}</td>
                        <td>{{ row.perc }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

        {% elif item.tipo == 'histograma' %}
            <div class="row text-center mb-3 fw-bold">
                <div class="col">Média: {{ "%.2f"|format(item.dados.config.media) }}</div>
                <div class="col">Mín: {{ item.dados.config.min }}</div>
                <div class="col">Máx: {{ item.dados.config.max }}</div>
            </div>
            <table class="table table-striped table-sm text-center w-75 mx-auto">
                <thead class="table-primary"><tr><th>Intervalo</th><th>Freq.</th><th>%</th></tr></thead>
                <tbody>
                    {% for row in item.dados.histograma %}
                    <tr><td>{{ row.label }}</td><td>{{ row.freq }}</td><td>{{ "%.1f"|format(row.perc) }}%</td></tr>
                    {% endfor %}
                </tbody>
            </table>

        {% elif item.tipo == 'cep' %}
            <div class="row text-center mb-3">
                <div class="col text-success fw-bold">Média: {{ "%.3f"|format(item.dados.estatisticas.media) }}</div>
                <div class="col text-danger fw-bold">LSE: {{ "%.3f"|format(item.dados.estatisticas.lse) }}</div>
                <div class="col text-danger fw-bold">LIE: {{ "%.3f"|format(item.dados.estatisticas.lie) }}</div>
            </div>
            <table class="table table-sm text-center w-50 mx-auto">
                <thead><tr><th>Amostra</th><th>Valor</th><th>Status</th></tr></thead>
                <tbody>
                    {% for p in item.dados.itens %}
                        {% set fora = p.value > item.dados.estatisticas.lse or p.value < item.dados.estatisticas.lie %}
                        <tr class="{{ 'table-danger fw-bold' if fora else '' }}">
                            <td>{{ p.label }}</td><td>{{ p.value }}</td>
                            <td>{{ 'FORA' if fora else 'OK' }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>

        {% elif item.tipo == 'dispersao' %}
            <div class="alert alert-light border text-center">
                <strong>Correlação (R):</strong> {{ "%.4f"|format(item.dados.stats.r) }} | 
                <strong>Equação:</strong> y = {{ "%.3f"|format(item.dados.stats.a) }}x + {{ "%.3f"|format(item.dados.stats.b) }}
            </div>
            <table class="table table-sm text-center w-50 mx-auto border">
                <thead class="bg-light"><tr><th>{{ item.dados.config.labelX }}</th><th>{{ item.dados.config.labelY }}</th></tr></thead>
                <tbody>
                    {% for p in item.dados.pontos %}
                    <tr><td>{{ p.x }}</td><td>{{ p.y }}</td></tr>
                    {% endfor %}
                </tbody>
            </table>

        {% elif item.tipo == 'ishikawa' %}
            <div class="row mt-4">
                {% for cat, causas in item.dados.diagrama.items() %}
                    {% if causas|length > 0 %}
                    <div class="col-6 mb-3">
                        <div class="border rounded p-2 h-100 bg-light">
                            <div class="fw-bold text-uppercase text-primary border-bottom pb-1 mb-2">{{ cat|replace('_', ' ') }}</div>
                            <ul class="mb-0 ps-3 small">{% for c in causas %}<li>{{ c }}</li>{% endfor %}</ul>
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>

        {% elif item.tipo == '5w2h' %}
            <table class="table table-bordered table-striped small align-middle mt-3">
                <thead class="table-dark text-center"><tr><th>WHAT</th><th>WHY</th><th>WHO</th><th>WHEN</th><th>COST</th></tr></thead>
                <tbody>
                    {% for acao in item.dados.itens %}
                    <tr>
                        <td class="fw-bold">{{ acao.what }}</td><td>{{ acao.why }}</td><td class="text-center">{{ acao.who }}</td>
                        <td class="text-center">{{ acao.when }}</td><td class="text-end text-success fw-bold">R$ {{ "%.2f"|format(acao.how_much) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-light fw-bold"><tr><td colspan="4" class="text-end">TOTAL:</td><td class="text-end">{{ item.dados.resumo.total_custo }}</td></tr></tfoot>
            </table>
        {% endif %}

    </div>
    {% endfor %}

</body>
</html>